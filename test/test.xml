<rekord>
    <data-source>
        <driver>org.postgresql.Driver</driver>
        <jdbc-url>jdbc:postgresql://localhost:5432/rekord</jdbc-url>
        <user>rekord_user</user>
        <password>rekord_password</password>
    </data-source>
    
    <logging mode="include">
        HUMAN_READABLE_QUERY
    </logging>
    
    <converter-classes>
        <converter-class class="org.magnos.rekord.convert.EnumCustomConverter" element="enum-custom-converter" />
        <converter-class class="org.magnos.rekord.convert.EnumNameConverter" element="enum-name-converter" />
        <converter-class class="org.magnos.rekord.convert.EnumOrdinalConverter" element="enum-ordinal-converter" />
    </converter-classes>
    
    <converters>
        <enum-custom-converter name="user-state" enum="org.magnos.rekord.UserState" custom-type="CHAR" UNVERIFIED="U" REGISTERED="R" DISABLED="D" />
    </converters>
    
    <classes>
        org.magnos.rekord.User
        org.magnos.rekord.Comment
        org.magnos.rekord.Commentable
    </classes>
    
    <table name="user" key="id">
        <fields>
            <column name="id" type="long" generated="true" read-only="true" />
            <column name="name" type="string" />
            <column name="created_timestamp" type="timestamp" generated="true" read-only="true" />
            <column name="state" type="string" converter="user-state" default-value="U" />
            <foreign-column name="commentable_id" type="long" foreign-table="commentable" foreign-column="id" />
            <one-to-one name="commentable" generated="true" lazy="true" non-null="true" join-table="commentable" join-load="all" join-key="commentable_id" />
            <one-to-many name="comments_by" lazy="true" read-only="true" join-table="comment" join-load="basic" join-key="user_id" />
        </fields>
        <load-profiles>
            <load-profile name="without-comments" fields="id, name, created_timestamp, commentable_id" />
            <load-profile name="for-link" fields="id, name" />
            <load-profile name="short-name" fields="id, name(3)" />
        </load-profiles>
        <native-queries>
            <query name="created-before" load="for-link"><![CDATA[
                SELECT #id, #name FROM "user" WHERE "created_timestamp" < ?date
            ]]></query>
            <query name="update-state"><![CDATA[
                UPDATE "user" SET "state" = ?new_state WHERE "id" = ?id
            ]]></query>
            <query name="by-name"><![CDATA[
                SELECT * FROM "user" WHERE "name" = ?name
            ]]></query>
            <query name="by-id"><![CDATA[
                SELECT * FROM "user" WHERE "id" = ?id
            ]]></query>
        </native-queries>
        <history table="user_history" timestamp="user_history_timestamp" columns="id, name" />
    </table>
    
    <table name="comment" key="id">
        <fields>
            <column name="id" type="long" generated="true" read-only="true" />
            <column name="text" type="string" />
            <foreign-column name="commentable_id" type="long" foreign-table="commentable" foreign-column="id" />
            <foreign-column name="user_id" type="long" foreign-table="user" foreign-column="id" />
            <many-to-one name="commentable" join-table="commentable" join-key="commentable_id" />
            <many-to-one name="user" join-table="user" join-load="for-link" join-key="user_id" />
        </fields>
        <load-profiles>
            <load-profile name="basic" fields="id, text, user_id, user[for-link]" />
        </load-profiles>
    </table>
    
    <table name="commentable" key="id">
        <fields>
            <column name="id" type="long" generated="true" read-only="true" />
            <column name="count" type="int" generated="true" default-value="42" />
            <column name="created_timestamp" type="timestamp" generated="true" read-only="true" />
            <one-to-many name="comments" lazy="true" join-table="comment" join-load="all" join-key="commentable_id" />
        </fields>        
    </table>
    
</rekord>